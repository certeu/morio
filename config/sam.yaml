# Target-specific configuration
targets:
  production:
    # The image to run in production
    # The specific tag will be added by the reconfigure script
    image: morio/sam
    # Note that this container is not exposed via Traefik in production
    volumes:
      - '{{{ MORIO_SAM_DOCKER_SOCKET }}}:{{{ MORIO_SAM_DOCKER_SOCKET }}}'
  development:
    # The image to run in development
    # The specific tag will be added by the reconfigure script
    image: morio/sam-dev
    volumes:
      - '{{{ MORIO_REPO_ROOT }}}:/morio'
      - '{{{ MORIO_SAM_DOCKER_SOCKET }}}:{{{ MORIO_SAM_DOCKER_SOCKET }}}'
    labels:
      - morio.sam
      # Tell traefik to watch this container
      #- traefik.enable=true
      # Attach to the morio_net network
      #- traefik.docker.network=morio_net
      # Match requests going to the SAM prefix (triple curly braces are required here)
      #- traefik.http.routers.sam.rule=PathPrefix(`/api/sam`)
      # Strip the prefix prior to forwarding
      #- traefik.http.middlewares.samStripPrefix.stripprefix.prefixes=/api/sam
      # Attach middleware to strip prefix
      #- traefik.http.routers.sam.middlewares=samStripPrefix
      # Forward to sam service
      #- traefik.http.routers.sam.service=sam
      # Only match requests on the https endpoint
      #- traefik.http.routers.sam.entrypoints=https
      # Forward to port on container
      #- 'traefik.http.services.sam.loadbalancer.server.port={{ MORIO_SAM_PORT }}'
      # Enable TLS
      #- traefik.http.routers.sam.tls=true

container:
  # Name it sam
  container_name: sam
  # Use the default network
  networks:
    default: null
  # Run an init inside the container to forward signales (and avoid PID 1)
  init: true
  environment:
    MORIO_SAM_DOCKER_SOCKET: '{{{ MORIO_SAM_DOCKER_SOCKET }}}'
    MORIO_SAM_HOST: '{{{ MORIO_SAM_HOST }}}'
    MORIO_SAM_LOG_LEVEL: '{{{ MORIO_SAM_LOG_LEVEL }}}'
    MORIO_SAM_PORT: '{{{ MORIO_SAM_PORT }}}'

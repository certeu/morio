name: Publish itsmorio/core OCI image

on:
  # This should not run on every PR, but it's here for testing this workflow
  pull_request:
  #release:
  #  types: [published]

jobs:
  build_and_push_to_registry:
    name: Build OCI Image
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
      attestations: write
      id-token: write
    steps:
      - name: Check out the repo
        uses: actions/checkout@v4

      - name: Create Build Context
        run: |
          cd core
          tar -cz -f ../core-context.tar.gz .

      - name: Store build context as artifact
        uses: actions/upload-artifact@v4
        id: artifact
        with:
          name: core-build-context
          path: core.tar.gz

      - name: Show build context URL (for debug)
        env:
          BUILD_CONTEXT: ${{ steps.artifact.artifact-url }}
        run: echo $BUILD_CONTEXT

      - name: Build the OCI image
        env:
          BUILD_CONTEXT: ${{ steps.artifact.artifact-url }}
        run: npm run ci:build:core $BUILD_CONTEXT

          #- name: Log in to Docker Hub
          #  uses: docker/login-action@f4ef78c080cd8ba55a85445d5b36e214a81df20a
          #  with:
          #    username: ${{ vars.DOCKER_USERNAME }}
          #    password: ${{ secrets.DOCKER_PAT }}

